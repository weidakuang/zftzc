<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>无政府共产主义同志社 · iOS 皮肤 · 极速静态版 v5</title>
<meta name="description" content="纯静态、清单驱动、极速加载（A/B 目录 + 精选/优秀 + 置顶 + 搜索 + 弹层）"/>
<style>
/* =========================================================
   iOS 视觉 + 结构稳定：仅换肤不改位
   本版侧重性能与可维护性：CSS 约 200 行，逻辑解耦
   ========================================================= */
:root{
  --bg:#F2F2F7; --card:#FFFFFF; --label:#000; --secondary:#6C6C70; --tertiary:#8E8E93; --hair:#D9D9D9; --tint:#007AFF;
  --shadow:0 .6px .8px rgba(0,0,0,.12), 0 1.5px 2px rgba(0,0,0,.08), 0 3.6px 4.8px rgba(0,0,0,.06);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--label);font:14px/1.6 -apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
img,video,audio{max-width:100%;display:block}
button{cursor:pointer}

/* 顶栏（位置不变） */
.header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(1.2) blur(20px);-webkit-backdrop-filter:saturate(1.2) blur(20px);background:rgba(250,250,252,.78);border-bottom:1px solid var(--hair)}
.nav{max-width:1100px;margin:auto;padding:12px 14px;display:flex;gap:12px;align-items:center}
.brand{display:flex;gap:10px;align-items:center}
.brand .badge{width:28px;height:28px;border-radius:9px;display:grid;place-items:center;background:#111;color:#fff;font-weight:900}
.brand .title{font-weight:900;letter-spacing:.02em}
.tabs{display:flex;gap:6px;margin-left:8px}
.tab{border:1px solid var(--hair);background:var(--card);border-radius:12px;padding:6px 10px;font-size:13px}
.tab.active{background:#000;color:#fff;border-color:#000}

.container{max-width:1100px;margin:auto;padding:16px}
.hidden{display:none!important}
.card{background:var(--card);border:1px solid var(--hair);border-radius:20px;box-shadow:var(--shadow);position:relative}
.section{margin-bottom:20px}
.h1{font-size:28px;font-weight:900;margin:8px 0 12px}
.h2{font-size:18px;font-weight:800;margin:0 0 8px}
.text-muted{color:var(--secondary)}

/* 英雄区与活动卡片（按你要求的配色） */
.hero{padding:24px;text-align:center;background:#E6F4FF;border:1px solid var(--hair);border-radius:20px}
.hero .big{font-size:34px;font-weight:1000;letter-spacing:.01em}
.hero .sub{color:var(--secondary);margin-top:6px}
.activity-card{background:#FFF3BF;border:1px solid var(--hair);border-radius:20px}

/* 徽记：黄=精选，绿=优秀，蓝=置顶 */
.badges{display:flex;gap:6px;align-items:center;margin-bottom:6px}
.dot{width:10px;height:10px;border-radius:10px;border:1px solid #0002}
.dot.yellow{background:#F1B300}
.dot.green{background:#0EA35A}
.dot.blue{background:#1D74F5}

/* 置顶公告（最多 2 条） */
.pinned-strip{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:720px){.pinned-strip{grid-template-columns:repeat(2,1fr)}}
.pill{display:flex;align-items:center;gap:8px;padding:10px;border:1px solid var(--hair);background:var(--card);border-radius:16px}
.pill .name{font-weight:700}

/* 精选/优秀网格：2→4 列 */
.curated-grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:720px){.curated-grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:1200px){.curated-grid{grid-template-columns:repeat(4,1fr)}}

/* 文章卡片（封面 + 文本） */
.post-card{display:flex;flex-direction:column;animation:fadeUp .35s ease-out both}
.thumb{aspect-ratio:16/9;overflow:hidden;border-bottom:1px solid var(--hair)}
.thumb img{width:100%;height:100%;object-fit:cover;transition:transform .4s ease}
.post-card:hover .thumb img{transform:scale(1.03)}
.color-thumb{width:100%;height:100%;}
.body{padding:12px}
.title{font-weight:800;font-size:15px}
.meta{font-size:12px;color:var(--secondary)}

/* 瀑布流（板块页） */
.masonry{column-count:1;column-gap:12px}
@media(min-width:720px){.masonry{column-count:2}}
@media(min-width:1024px){.masonry{column-count:3}}
.masonry .mitem{break-inside:avoid;margin:0 0 12px}

/* 搜索 */
.search{display:flex;gap:8px;align-items:center}
.search input{flex:1;padding:10px 12px;border:1px solid var(--hair);border-radius:12px;background:var(--card)}
.search .btn{border:1px solid var(--hair);border-radius:12px;background:var(--card);padding:8px 12px}

/* 页脚 */
.footer{border-top:1px solid var(--hair);padding:16px;color:var(--tertiary)}
.btn{border:1px solid var(--hair);background:var(--card);border-radius:12px;padding:8px 12px}
.btn.primary{background:var(--tint);color:#fff;border-color:#0a84ff}

@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.note{padding:8px 10px;border:1px dashed var(--hair);border-radius:12px;background:var(--card);color:var(--secondary)}
.hidden-when-empty:empty{display:none}
</style>
</head>
<body>
<header class="header">
  <div class="nav">
    <div class="brand"><div class="badge">Ⓐ</div><div class="title">无政府共产主义同志社</div></div>
    <div class="tabs" id="tabs">
      <button data-href="#home" class="tab active">首页</button>
      <button data-href="#board" class="tab">板块</button>
      <button data-href="#official" class="tab">我们的内容</button>
      <button data-href="#submit" class="tab">如何投稿</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- 首页 -->
  <section id="page-home" class="section">
    <div class="hero">
      <div class="big">（站点大标题占位）</div>
      <div class="sub">自由不是混乱，而是自我管理。这里是一块轻便的、去中心的投稿地。</div>
    </div>

    <div class="section">
      <div class="h2">我们的活动</div>
      <div class="card activity-card" style="padding:16px">
        <div style="font-weight:900;font-size:22px">暂无活动</div>
        <div class="text-muted">欢迎投稿</div>
      </div>
    </div>

    <div class="section">
      <div class="h2">置顶公告</div>
      <div id="home-pinned" class="pinned-strip"></div>
      <div id="home-pinned-empty" class="note">暂无置顶公告。请在 <code>b/</code> 中文章文件夹名加 <code>_P</code> 置顶。</div>
    </div>

    <div class="section">
      <div class="h2">精选与优秀</div>
      <div id="home-curated" class="curated-grid"></div>
    </div>
  </section>

  <!-- 板块 -->
  <section id="page-board" class="section hidden">
    <div class="h1">板块 / 搜索</div>
    <div class="search" style="margin:8px 0 12px">
      <input id="q" placeholder="搜索：标题 + 正文（home.txt）" />
      <button id="btnSearch" class="btn">搜索</button>
      <button id="btnClear" class="btn">清空</button>
    </div>
    <div id="searchInfo" class="text-muted hidden-when-empty" style="margin:6px 0"></div>
    <div id="boardList" class="masonry"></div>
  </section>

  <!-- 官方内容 -->
  <section id="page-official" class="section hidden">
    <div class="h1">我们的内容 / 公告</div>
    <div id="officialTop" class="curated-grid" style="margin-bottom:12px"></div>
    <div id="officialList" class="curated-grid"></div>
  </section>

  <!-- 投稿（邮箱 + 规则 + 彩蛋） -->
  <section id="page-submit" class="section hidden">
    <div class="h1">如何投稿</div>
    <div class="card" style="padding:14px">
      <div class="h2">邮箱与规则</div>
      <ul>
        <li>主用邮箱：<b id="mailMain" style="cursor:pointer">p23333333666999@163.com</b></li>
        <li>备用邮箱：<b>teshuzy@gmail.com</b></li>
        <li>只收 <code>jpg/png/webp</code> 图片（≤ 9 张），视频 <code>mp4</code>（≤ 20MB/个），音频 <code>mp3</code>（≤ 2 个）。</li>
        <li>正文放在 <code>home.txt</code>，作者+日期放在 <code>main.txt</code> 或 <code>命.txt</code>；文件夹名即标题。</li>
      </ul>
    </div>
  </section>
</main>

<!-- 文章弹层 -->
<div id="modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:grid;place-items:center;padding:16px;z-index:60">
  <div class="card" style="max-width:900px;max-height:90vh;overflow:auto;width:100%">
    <div style="display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--hair);padding:10px 14px">
      <div id="mTitle" style="font-weight:900"></div>
      <button id="mClose" class="btn">关闭</button>
    </div>
    <div style="padding:12px">
      <div class="badges" id="mBadges"></div>
      <div id="mMeta" class="meta" style="margin-bottom:8px"></div>
      <article id="mBody" style="white-space:pre-wrap"></article>
      <div id="mMedia" style="margin-top:12px;display:grid;grid-template-columns:1fr;gap:10px"></div>
    </div>
  </div>
</div>

<footer class="footer container">© 2025 无政府主义同志社 · 独立思考，明辨是非</footer>

<script>
/* =========================================================
   极简工具/辅助
   ========================================================= */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const pages = ["home","board","official","submit"];
const extsImg = ["jpg","jpeg","png","webp"];
const state = { A:{list:[],byKey:{}}, B:{list:[],byKey:{}}, capacity:8 };

function switchTo(hash){
  const h = (hash||location.hash||"#home").replace('#','');
  pages.forEach(p=>{ $('#page-'+p).classList.toggle('hidden', p!==h); });
  $$('#tabs .tab').forEach(btn=> btn.classList.toggle('active', btn.dataset.href === '#'+h));
}
window.addEventListener('hashchange', ()=>switchTo());
$$('#tabs .tab').forEach(b=> b.addEventListener('click',()=>{ location.hash=b.dataset.href; }));

const debounce = (fn,ms=200)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } };
const idle = (cb)=> (window.requestIdleCallback||((f)=>setTimeout(f,0)))(cb);

/* =========================================================
   I/O：并发加载 + GET 探测 + 浏览器缓存
   ========================================================= */
async function loadManifestTxt(name){ try{ const r=await fetch(name); if(!r.ok) throw 0; return await r.text(); }catch{ return null; } }
async function tryLoadText(path){ try{ const r=await fetch(path); if(!r.ok) throw 0; return await r.text(); }catch{ return ''; } }
async function tryExists(path){ try{ const r=await fetch(path,{method:'GET'}); return r.ok; }catch{ return false; } }

/* 快速封面探测：卡片阶段仅找 1.jpg|jpeg|png|webp + 1.mp4 */
async function probeMediaFast(base){
  const imgs=[], vids=[], auds=[];
  for(const ext of extsImg){ const p=`${base}/1.${ext}`; if(await tryExists(p)){ imgs.push(p); break; } }
  const v1=`${base}/1.mp4`; if(await tryExists(v1)) vids.push(v1);
  return {imgs,vids,auds};
}
/* 全量探测：在弹层打开时再做，避免首屏大量 404 */
async function probeMediaFull(base){
  const imgs=[], vids=[], auds=[];
  for(let i=1;i<=9;i++){ for(const ext of extsImg){ const p=`${base}/${i}.${ext}`; if(await tryExists(p)){ imgs.push(p); break; } } }
  for(let i=1;i<=2;i++){ const p=`${base}/${i}.mp4`; if(await tryExists(p)) vids.push(p); }
  for(let i=1;i<=2;i++){ const p=`${base}/${i}.mp3`; if(await tryExists(p)) auds.push(p); }
  return {imgs,vids,auds};
}

/* 解析文件夹名中的标签 */
function parseFlagsFromFolder(name){
  let raw=name, title=name; const flags={ ss:false, s:false, p:false };
  if(/_SS/i.test(title)){ flags.ss=true; title=title.replace(/_SS/ig,''); }
  if(/_S(?!S)/i.test(title)){ flags.s=true; title=title.replace(/_S(?!S)/ig,''); }
  if(/_P/i.test(title)){ flags.p=true; title=title.replace(/_P/ig,''); }
  return { title:title.trim(), flags, raw };
}
function fmtDate(t){ if(!t) return ''; const d=new Date(t); return isNaN(d)?'':d.toISOString().slice(0,10); }
function guessDate(str){ if(!str) return 0; const m=str.match(/(\d{4}).{0,2}(\d{1,2}).{0,2}(\d{1,2})/); if(m){ return new Date(+m[1],+m[2]-1,+m[3]).getTime(); } const m2=str.match(/(\d{4}-\d{1,2}-\d{1,2})/); return m2? new Date(m2[1]).getTime():0; }

/* 加载单篇（并发）：home + main + 快速媒体 */
async function loadArticle(root, folder){
  const {title, flags, raw} = parseFlagsFromFolder(folder);
  const base=`${root}/${raw}`;
  const [home, mainTxt, media] = await Promise.all([
    tryLoadText(`${base}/home.txt`),
    (async()=> await tryLoadText(`${base}/main.txt`) || await tryLoadText(`${base}/命.txt`))(),
    probeMediaFast(base),
  ]);
  const dateMs = guessDate(mainTxt);
  return { key:raw, title, flags, root, base, home, mainTxt, dateMs, media };
}

/* 初始化：并发读取清单与文章；非关键渲染延后 */
async function init(){
  const [ma, mb] = await Promise.all([ loadManifestTxt('manifest_a.txt'), loadManifestTxt('manifest_b.txt') ]);
  if(ma){ const fs = ma.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); const arr = await Promise.all(fs.map(f=> loadArticle('a', f))); state.A.list=arr; state.A.byKey=Object.fromEntries(arr.map(x=>[x.key,x])); }
  if(mb){ const fs = mb.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); const arr = await Promise.all(fs.map(f=> loadArticle('b', f))); state.B.list=arr; state.B.byKey=Object.fromEntries(arr.map(x=>[x.key,x])); }
  renderHome(); idle(()=>{ renderBoard(); renderOfficial(); });
}

/* 视图构建 */
function gradForKey(key){ let h=0; for(const c of String(key)) h=(h*31 + c.charCodeAt(0))>>>0; const hues=[210,220,230,200,190,180,160,150]; const hue=hues[h%hues.length]; return `linear-gradient(135deg, hsl(${hue} 80% 96%), hsl(${hue} 80% 90%))`; }
function badgeDots(a, mount){ const wrap=document.createElement('div'); wrap.className='badges'; if(a.flags.p) wrap.appendChild(Object.assign(document.createElement('span'),{className:'dot blue'})); if(a.flags.ss) wrap.appendChild(Object.assign(document.createElement('span'),{className:'dot yellow'})); if(a.flags.s) wrap.appendChild(Object.assign(document.createElement('span'),{className:'dot green'})); if(mount){ mount.innerHTML=''; mount.appendChild(wrap);} return wrap; }
function el(tag, attrs={}, children){ const e=document.createElement(tag); for(const k in attrs){ if(k==='_html') e.innerHTML=attrs[k]; else if(k==='class') e.className=attrs[k]; else e.setAttribute(k,attrs[k]); } if(children){ (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=> e.appendChild(typeof c==='string'?document.createTextNode(c):c)); } return e; }

function postCard(a){
  const card=el('div',{class:'card mitem post-card'});
  const th=el('div',{class:'thumb'});
  if(a.media.imgs && a.media.imgs[0]){
    th.appendChild(el('img',{src:a.media.imgs[0],alt:a.title,loading:'lazy'}));
  }else{
    th.appendChild(el('div',{class:'color-thumb',style:`display:grid;place-items:center;background:${gradForKey(a.key)}`}, el('div',{style:'opacity:.55;font-weight:800'},'无封面')));
  }
  const bd=el('div',{class:'body'});
  const badges=badgeDots(a);
  const t=el('div',{class:'title'}, a.title);
  const m=el('div',{class:'meta'}, (a.mainTxt? a.mainTxt.split(/\n/)[0] : ''));
  const btn=el('button',{class:'btn',style:'margin-top:8px'},'打开'); btn.addEventListener('click',()=>openModal(a));
  bd.appendChild(badges); bd.appendChild(t); bd.appendChild(m); bd.appendChild(btn);
  card.appendChild(th); card.appendChild(bd);
  return card;
}

function renderHome(){
  const pinBox=$('#home-pinned'); const pinEmpty=$('#home-pinned-empty'); pinBox.innerHTML='';
  const pinned = state.B.list.filter(x=>x.flags.p).sort((a,b)=> (b.dateMs||0)-(a.dateMs||0)).slice(0,2);
  if(pinned.length){ pinEmpty.style.display='none'; pinned.forEach(a=>{ const pill=el('div',{class:'pill'}); pill.appendChild(el('span',{class:'dot blue'})); pill.appendChild(el('div',{class:'name'},a.title)); const open=el('button',{class:'btn',style:'margin-left:auto'},'查看'); open.addEventListener('click',()=>openModal(a)); pill.appendChild(open); pinBox.appendChild(pill); }); }
  else{ pinEmpty.style.display='block'; }

  const ss = state.A.list.filter(a=>a.flags.ss).sort((a,b)=> (b.dateMs||0)-(a.dateMs||0));
  const s  = state.A.list.filter(a=>!a.flags.ss && a.flags.s).sort((a,b)=> (b.dateMs||0)-(a.dateMs||0));
  const cap = state.capacity; const needSS=Math.min(6, ss.length); const needS=Math.min(2, s.length);
  let pick=[...ss.slice(0,needSS), ...s.slice(0,needS)];
  const remain = cap - pick.length; if(remain>0){ pick = pick.concat([...ss.slice(needSS), ...s.slice(needS)].slice(0,remain)); }
  const grid=$('#home-curated'); grid.innerHTML=''; const frag=document.createDocumentFragment(); pick.forEach(a=> frag.appendChild(postCard(a))); grid.appendChild(frag);
}

function renderBoard(filterText=''){
  const list = state.A.list.slice().sort((a,b)=> (b.dateMs||0)-(a.dateMs||0));
  const box=$('#boardList'); box.innerHTML=''; const q=filterText.trim(); let hit=0; const frag=document.createDocumentFragment();
  list.forEach(a=>{ const hay=(a.title+'\n'+(a.home||'')); if(q && !hay.includes(q)) return; hit++; frag.appendChild(postCard(a)); });
  box.appendChild(frag); $('#searchInfo').textContent = q? `搜索 “${q}” 命中 ${hit} 条` : '';
}

function renderOfficial(){
  const pinned = state.B.list.filter(x=>x.flags.p).sort((a,b)=> (b.dateMs||0)-(a.dateMs||0));
  const others = state.B.list.filter(x=>!x.flags.p).sort((a,b)=> (b.dateMs||0)-(a.dateMs||0));
  const top=$('#officialTop'); const list=$('#officialList'); top.innerHTML=''; list.innerHTML='';
  const f1=document.createDocumentFragment(); pinned.forEach(a=> f1.appendChild(postCard(a))); top.appendChild(f1);
  const f2=document.createDocumentFragment(); others.forEach(a=> f2.appendChild(postCard(a))); list.appendChild(f2);
}

/* 弹层：先显示快速封面，后台补齐所有媒体（并去重） */
async function openModal(a){
  $('#mTitle').textContent=a.title; badgeDots(a, $('#mBadges'));
  const meta = (a.mainTxt? a.mainTxt.split(/\n/)[0] : '') + (a.dateMs? ' · '+fmtDate(a.dateMs):''); $('#mMeta').textContent=meta;
  $('#mBody').textContent = a.home || '(无正文)';
  const mediaBox=$('#mMedia'); mediaBox.innerHTML='';
  (a.media.imgs||[]).forEach(src=> mediaBox.appendChild(el('img',{src,loading:'lazy'})) );
  (a.media.vids||[]).forEach(src=>{ const v=el('video',{src,controls:'',playsinline:''}); v.style.maxHeight='360px'; mediaBox.appendChild(v); });
  (a.media.auds||[]).forEach(src=> mediaBox.appendChild(el('audio',{src,controls:''})) );
  $('#modal').classList.remove('hidden');
  // 异步全量探测并增量渲染
  const full = await probeMediaFull(a.base);
  const seenImg=new Set((a.media.imgs||[]));
  full.imgs.forEach(src=>{ if(seenImg.has(src)) return; mediaBox.appendChild(el('img',{src,loading:'lazy'})); });
  const seenVid=new Set((a.media.vids||[])); full.vids.forEach(src=>{ if(seenVid.has(src)) return; const v=el('video',{src,controls:'',playsinline:''}); v.style.maxHeight='360px'; mediaBox.appendChild(v); });
  full.auds.forEach(src=> mediaBox.appendChild(el('audio',{src,controls:''})) );
  a.media = full; // 缓存到对象，下次更快
}
$('#mClose').addEventListener('click',()=> $('#modal').classList.add('hidden'));

/* 搜索交互：防抖 */
$('#btnSearch').addEventListener('click',()=>{ renderBoard($('#q').value); });
$('#btnClear').addEventListener('click',()=>{ $('#q').value=''; renderBoard(''); });
$('#q').addEventListener('input', debounce(()=> renderBoard($('#q').value), 200));

/* 邮箱彩蛋 */
(function(){ const main=$('#mailMain'); if(!main) return; let clicks=0,timer=null; const reset=()=>{clicks=0; if(timer){clearTimeout(timer); timer=null;}}; main.addEventListener('click',()=>{ clicks++; if(timer) clearTimeout(timer); timer=setTimeout(reset,1200); if(clicks>=5){ reset(); const t=document.createElement('div'); t.style='position:fixed;right:16px;top:16px;z-index:99;background:#111;color:#fff;padding:10px 12px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,.2)'; t.innerHTML='<b>GPT5 制作</b><br>感谢：英特尔 · Open AI · AURAX·MINI · Apple · Google · GPT五'; document.body.appendChild(t); setTimeout(()=> t.remove(), 3200); } }); })();

/* 启动 */
switchTo();
init();
</script>
</body>
</html>
